package com.revshop.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import java.util.List;
import java.util.ArrayList;

import com.revshop.model.CartItem;
import com.revshop.util.DBConnection;

public class cartDAO {

    // ================= ADD TO CART =================
    public void addToCart(int userId, int productId, int quantity) {

        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        String checkSql =
            "SELECT quantity FROM cart WHERE user_id=? AND product_id=?";

        String insertSql =
            "INSERT INTO cart(cart_id, user_id, product_id, quantity) " +
            "VALUES (cart_seq.NEXTVAL, ?, ?, ?)";

        String updateSql =
            "UPDATE cart SET quantity = quantity + ? " +
            "WHERE user_id=? AND product_id=?";

        try {
            con = DBConnection.getConnection();

            ps = con.prepareStatement(checkSql);
            ps.setInt(1, userId);
            ps.setInt(2, productId);
            rs = ps.executeQuery();

            if (rs.next()) {
                ps.close();
                ps = con.prepareStatement(updateSql);
                ps.setInt(1, quantity);
                ps.setInt(2, userId);
                ps.setInt(3, productId);
                ps.executeUpdate();
            } else {
                ps.close();
                ps = con.prepareStatement(insertSql);
                ps.setInt(1, userId);
                ps.setInt(2, productId);
                ps.setInt(3, quantity);
                ps.executeUpdate();
            }

            System.out.println("Product added to cart!");

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try { if (rs != null) rs.close(); } catch (Exception e) {}
            try { if (ps != null) ps.close(); } catch (Exception e) {}
            try { if (con != null) con.close(); } catch (Exception e) {}
        }
    }

    // ================= VIEW CART =================
    public void viewCart(int userId) {

        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        String sql =
            "SELECT c.product_id, p.name, c.quantity, " +
            "       CASE " +
            "         WHEN p.discount_price IS NOT NULL " +
            "              THEN p.price - (p.price * p.discount_price / 100) " +
            "         ELSE p.price " +
            "       END AS final_price " +
            "FROM cart c " +
            "JOIN products p ON c.product_id = p.product_id " +
            "WHERE c.user_id = ?";

        try {
            con = DBConnection.getConnection();
            ps = con.prepareStatement(sql);
            ps.setInt(1, userId);
            rs = ps.executeQuery();

            boolean empty = true;
            System.out.println("ProductID | Name | Qty | Price | Total");

            while (rs.next()) {
                empty = false;

                int qty = rs.getInt("quantity");
                double price = rs.getDouble("final_price");
                double total = qty * price;

                System.out.println(
                    rs.getInt("product_id") + " | " +
                    rs.getString("name") + " | " +
                    qty + " | " +
                    price + " | " +
                    total
                );
            }

            if (empty) {
                System.out.println("Cart is empty");
            }

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try { if (rs != null) rs.close(); } catch (Exception e) {}
            try { if (ps != null) ps.close(); } catch (Exception e) {}
            try { if (con != null) con.close(); } catch (Exception e) {}
        }
    }

    // ================= GET CART ITEMS (FOR ORDER) =================
    public List<CartItem> getCartItems(int userId, Connection con)
            throws SQLException {

        List<CartItem> items = new ArrayList<CartItem>();

        String sql =
            "SELECT c.product_id, c.quantity, " +
            "       CASE " +
            "         WHEN p.discount_price IS NOT NULL " +
            "              THEN p.price - (p.price * p.discount_price / 100) " +
            "         ELSE p.price " +
            "       END AS final_price " +
            "FROM cart c " +
            "JOIN products p ON c.product_id = p.product_id " +
            "WHERE c.user_id = ?";

        PreparedStatement ps = con.prepareStatement(sql);
        ps.setInt(1, userId);

        ResultSet rs = ps.executeQuery();

        while (rs.next()) {
            items.add(new CartItem(
                rs.getInt("product_id"),
                rs.getInt("quantity"),
                rs.getDouble("final_price")
            ));
        }

        rs.close();
        ps.close();

        return items;
    }

    // ================= REMOVE FROM CART =================
    public void removeFromCart(int userId, int productId) {

        Connection con = null;
        PreparedStatement ps = null;

        String sql =
            "DELETE FROM cart WHERE user_id=? AND product_id=?";

        try {
            con = DBConnection.getConnection();
            ps = con.prepareStatement(sql);
            ps.setInt(1, userId);
            ps.setInt(2, productId);

            int rows = ps.executeUpdate();

            if (rows > 0)
                System.out.println("Product removed from cart");
            else
                System.out.println("Product not found in cart");

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try { if (ps != null) ps.close(); } catch (Exception e) {}
            try { if (con != null) con.close(); } catch (Exception e) {}
        }
    }

    // ================= CLEAR CART =================
    public void clearCart(int userId, Connection con) throws SQLException {

        String sql = "DELETE FROM cart WHERE user_id = ?";
        PreparedStatement ps = con.prepareStatement(sql);
        ps.setInt(1, userId);
        ps.executeUpdate();
        ps.close();
    }
}