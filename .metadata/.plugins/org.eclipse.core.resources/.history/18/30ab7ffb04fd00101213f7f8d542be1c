//package com.revshop.service;
//import com.revshop.dao.cartDAO;
//public class CartService {
//	private cartDAO cartDAO = new cartDAO();
//
//    public void addProduct(int buyerId, int productId, int qty) {
//        cartDAO.addToCart(buyerId, productId, qty);
//    }
//
//    public void viewCart(int buyerId) {
//        cartDAO.viewCart(buyerId);
//    }
//
//    public void removeProduct(int buyerId, int productId) {
//        cartDAO.removeFromCart(buyerId, productId);
//    }
//
//}

package com.revshop.service;

import java.sql.*;
import java.util.List;

import com.revshop.util.DBConnection;
import com.revshop.dao.CartDAO;
import com.revshop.model.CartItem;

public class CartService {

    private CartDAO cartDAO = new CartDAO();
    private NotificationService notificationService = new NotificationService();

    public void placeOrder(int buyerId) throws SQLException {

        Connection con = DBConnection.getConnection();
        con.setAutoCommit(false); 

        try {
           
            String orderSql = "INSERT INTO orders (user_id, order_date) VALUES (?, SYSDATE)";
            PreparedStatement orderPs =
                    con.prepareStatement(orderSql, new String[]{"order_id"});

            orderPs.setInt(1, buyerId);
            orderPs.executeUpdate();

            // get generated order_id
            ResultSet rs = orderPs.getGeneratedKeys();
            int orderId = 0;
            if (rs.next()) {
                orderId = rs.getInt(1);
            }

           
            List<CartItem> cartItems = cartDAO.getCartItems(buyerId, con);

            
            for (CartItem item : cartItems) {

                String itemSql =
                        "INSERT INTO order_items (order_id, product_id, quantity, price) " +
                        "VALUES (?, ?, ?, ?)";

                PreparedStatement itemPs = con.prepareStatement(itemSql);
                itemPs.setInt(1, orderId);
                itemPs.setInt(2, item.getProductId());
                itemPs.setInt(3, item.getQuantity());
                itemPs.setDouble(4, item.getPrice());
                itemPs.executeUpdate();

                
                int sellerId = getSellerIdByProduct(item.getProductId(), con);

                notificationService.notifySeller(
                        sellerId,
                        "New order received for your product"
                );
            }

           
            notificationService.notifyBuyer(
                    buyerId,
                    "Your order has been placed successfully"
            );

          
            cartDAO.clearCart(buyerId, con);

            con.commit();
            System.out.println("Order placed successfully!");

        } catch (Exception e) {
            con.rollback();
            e.printStackTrace();
        } finally {
            con.close();
        }
    }

   
    private int getSellerIdByProduct(int productId, Connection con) throws SQLException {

        String sql = "SELECT seller_id FROM products WHERE product_id=?";
        PreparedStatement ps = con.prepareStatement(sql);
        ps.setInt(1, productId);

        ResultSet rs = ps.executeQuery();
        int sellerId = 0;
        if (rs.next()) {
            sellerId = rs.getInt("seller_id");
        }

        rs.close();
        ps.close();
        return sellerId;
    }
}
