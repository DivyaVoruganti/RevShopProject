package com.revshop.service;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;

import com.revshop.dao.cartDAO;
import com.revshop.dao.ProductDAO;
import com.revshop.model.CartItem;
import com.revshop.util.DBConnection;

public class CartService {

    private cartDAO cartDAO = new cartDAO();
    private ProductDAO productDAO = new ProductDAO();
    private NotificationService notificationService = new NotificationService();

    // âœ… ADD TO CART WITH STOCK CHECK
    public boolean addProductWithStockCheck(int userId, int productId, int quantity) {
        try {
            int availableStock = productDAO.getAvailableStock(productId); // throws SQLException

            if (availableStock <= 0) {
                System.out.println("Product is out of stock!");
                return false;
            }

            if (quantity > availableStock) {
                System.out.println("Only " + availableStock + " items available. Try again.");
                return false;
            }

        } catch (SQLException e) {
            System.out.println("Error checking stock: " + e.getMessage());
            return false;
        }

        // cartDAO.addToCart does NOT throw SQLException, so no catch needed
        cartDAO.addToCart(userId, productId, quantity);
        System.out.println("Product added to cart!");
        return true;
    }

    // âœ… VIEW CART (USES REAL PRODUCT PRICE)
    public void viewCart(int userId) {
        try (Connection con = DBConnection.getConnection()) {
            List<CartItem> cartItems = cartDAO.getCartItems(userId, con);

            if (cartItems.isEmpty()) {
                System.out.println("Your cart is empty!");
                return;
            }

            System.out.println("ProductID | Quantity | Price | Total");

            for (CartItem item : cartItems) {
                double price = getProductPrice(item.getProductId(), con); // throws SQLException
                double total = price * item.getQuantity();

                System.out.println(item.getProductId() + " | " +
                        item.getQuantity() + " | " + price + " | " + total);
            }

        } catch (SQLException e) {
            System.out.println("Error fetching cart: " + e.getMessage());
        }
    }

    public void removeProduct(int userId, int productId) {
        cartDAO.removeFromCart(userId, productId); // no SQLException, safe
    }

    // âœ… PLACE ORDER
    public void placeOrder(int buyerId) {
        try (Connection con = DBConnection.getConnection()) {
            con.setAutoCommit(false);

            // create order
            String orderSql = "INSERT INTO orders (user_id, order_date) VALUES (?, SYSDATE)";
            PreparedStatement orderPs = con.prepareStatement(orderSql, new String[]{"order_id"});
            orderPs.setInt(1, buyerId);
            orderPs.executeUpdate();

            ResultSet rs = orderPs.getGeneratedKeys();
            int orderId = 0;
            if (rs.next()) {
                orderId = rs.getInt(1);
            }
            rs.close();
            orderPs.close();

            List<CartItem> cartItems = cartDAO.getCartItems(buyerId, con);

            for (CartItem item : cartItems) {
                double price = getProductPrice(item.getProductId(), con);

                String itemSql = "INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)";
                PreparedStatement itemPs = con.prepareStatement(itemSql);
                itemPs.setInt(1, orderId);
                itemPs.setInt(2, item.getProductId());
                itemPs.setInt(3, item.getQuantity());
                itemPs.setDouble(4, price);
                itemPs.executeUpdate();
                itemPs.close();

                int sellerId = getSellerIdByProduct(item.getProductId(), con);
                notificationService.notifySeller(sellerId, "New order received for product ID: " + item.getProductId());
            }

            notificationService.notifyBuyer(buyerId, "Your order has been placed successfully");
            cartDAO.clearCart(buyerId, con);
            con.commit();

            System.out.println("Order placed successfully!");

        } catch (SQLException e) {
            System.out.println("Error placing order: " + e.getMessage());
            e.printStackTrace();
        }
    }

    // ðŸ”‘ FETCH REAL PRODUCT PRICE
    private double getProductPrice(int productId, Connection con) throws SQLException {
        String sql = "SELECT price FROM products WHERE product_id=?";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setInt(1, productId);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return rs.getDouble("price");
                }
            }
        }
        return 0;
    }

    private int getSellerIdByProduct(int productId, Connection con) throws SQLException {
        String sql = "SELECT seller_id FROM products WHERE product_id=?";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setInt(1, productId);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return rs.getInt("seller_id");
                }
            }
        }
        return 0;
    }
}
