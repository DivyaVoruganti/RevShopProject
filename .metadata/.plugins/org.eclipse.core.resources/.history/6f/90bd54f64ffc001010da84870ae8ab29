package com.revshop.dao;

import java.sql.*;
import com.revshop.util.DBConnection;

public class cartDAO {
	public void addToCart(int userId, int productId, int quantity) {

		Connection con = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		String checkSql = "SELECT quantity FROM cart WHERE buyer_id=? AND product_id=?";
		String insertSql = "INSERT INTO cart(cart_id,user_id, product_id, quantity) VALUES(?,?,?,?)";
		String updateSql = "UPDATE cart SET quantity = quantity + ? WHERE buyer_id=? AND product_id=?";

		try {
			con = DBConnection.getConnection();

			ps = con.prepareStatement(checkSql);
			ps.setInt(1, userId);
			ps.setInt(2, productId);
            ps.setInt(3, quantity);


			rs = ps.executeQuery();

			if (rs.next()) {
				ps = con.prepareStatement(updateSql);
				ps.setInt(1, quantity);
				ps.setInt(2, userId);
				ps.setInt(3, productId);
				ps.executeUpdate();
			} else {
				ps = con.prepareStatement(insertSql);
				ps.setInt(1, userId);
				ps.setInt(2, productId);
				ps.setInt(3, quantity);
				ps.executeUpdate();
			}

			System.out.println(" Product added to cart");

		} catch (Exception e) {
			e.printStackTrace();
		}finally {
            try {
                if (rs != null) rs.close();
                if (ps != null) ps.close();
                if (con != null) con.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
		
	}

	public void viewCart(int buyerId) {
		Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

	        String sql =
	            "SELECT p.product_id, p.name, p.price, c.quantity"+
	            "FROM cart c"+
	            "JOIN products p ON c.product_id = p.product_id"+
	            "WHERE c.buyer_id = ?";

	        try {con = DBConnection.getConnection();
	              ps = con.prepareStatement(sql);

	            ps.setInt(1, buyerId);
	            rs = ps.executeQuery();

	            System.out.println("ID | Name | Price | Qty | Total");
	            boolean empty = true;

	            while (rs.next()) {
	                empty = false;
	                double total = rs.getDouble("price") * rs.getInt("quantity");

	                System.out.println(
	                    rs.getInt("product_id") + " | " +
	                    rs.getString("name") + " | " +
	                    rs.getDouble("price") + " | " +
	                    rs.getInt("quantity") + " | " +
	                    total
	                );
	            }

	            if (empty) {
	                System.out.println(" Cart is empty");
	            }

	        } catch (Exception e) {
	            e.printStackTrace();
	        }finally {
	            try {
	                if (rs != null) rs.close();
	                if (ps != null) ps.close();
	                if (con != null) con.close();
	            } catch (Exception e) {
	                e.printStackTrace();
	            }
	        }
	        
	    }

	public void removeFromCart(int buyerId, int productId) {
		 Connection con = null;
	        PreparedStatement ps = null;

	        String sql = "DELETE FROM cart WHERE buyer_id=? AND product_id=?";

	        try {con = DBConnection.getConnection();
	            ps = con.prepareStatement(sql);

	            ps.setInt(1, buyerId);
	            ps.setInt(2, productId);

	            int rows = ps.executeUpdate();

	            if (rows > 0)
	                System.out.println(" Product removed from cart");
	            else
	                System.out.println("Product not found in cart");

	        } catch (Exception e) {
	            e.printStackTrace();
	        }
	    }

}
