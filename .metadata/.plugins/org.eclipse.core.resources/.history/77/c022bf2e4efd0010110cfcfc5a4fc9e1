package com.revshop.service;
import java.sql.SQLException;
import java.sql.Connection;
import java.util.Scanner;
import com.revshop.util.DBConnection;
import com.revshop.dao.cartDAO;
import java.sql.PreparedStatement;
import java.sql.*;

import com.revshop.model.CartItem;

import java.util.List;
import java.util.ArrayList;

public class CheckoutService {
	
	private cartDAO cartDao1 = new cartDAO(); 
	private CartService cartService = new CartService();
    private NotificationService notificationService = new NotificationService();
    private Scanner sc = new Scanner(System.in);
    
    public void clearCart(int userId) throws SQLException {
        Connection con = DBConnection.getConnection();
        String sql = "DELETE FROM cart WHERE user_id = ?";
        PreparedStatement ps = con.prepareStatement(sql);
        ps.setInt(1, userId);
        
        ps.executeUpdate();
    }
    
    public void checkout(int userId) {
        Connection con = null;
        try {
            con = DBConnection.getConnection();
            con.setAutoCommit(false);

            System.out.println("\n===== CHECKOUT =====");

            // Show the current cart
            cartDao1.viewCart(userId);

            sc.nextLine(); // consume newline
            System.out.print("Enter shipping address: ");
            String shipping = sc.nextLine();
            System.out.print("Enter billing address: ");
            String billing = sc.nextLine();

            // Get cart items as List<CartItem>
            List<CartItem> cartItems = cartDao1.getCartItems(userId, con);

            if (cartItems.isEmpty()) {
                System.out.println("Cart is empty. Cannot checkout.");
                return;
            }

            // Calculate total
            double total = 0;
            for (CartItem item : cartItems) {
                total += item.getQuantity() * item.getPrice();
            }

            // Insert into orders table
            String orderSql = "INSERT INTO orders (user_id, total_amount, shipping_address, billing_address) VALUES (?, ?, ?, ?)";
            PreparedStatement orderPs = con.prepareStatement(orderSql, new String[]{"order_id"});
            orderPs.setInt(1, userId);
            orderPs.setDouble(2, total);
            orderPs.setString(3, shipping);
            orderPs.setString(4, billing);
            orderPs.executeUpdate();

            // Get generated order ID
            ResultSet orderKeys = orderPs.getGeneratedKeys();
            orderKeys.next();
            int orderId = orderKeys.getInt(1);

            // Insert each item into order_items
            String itemSql = "INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)";
            PreparedStatement itemPs = con.prepareStatement(itemSql);

            for (CartItem item : cartItems) {
                itemPs.setInt(1, orderId);
                itemPs.setInt(2, item.getProductId());
                itemPs.setInt(3, item.getQuantity());
                itemPs.setDouble(4, item.getPrice());
                itemPs.addBatch();
            }
            itemPs.executeBatch();

            // Clear the cart
            cartDao1.clearCart(userId, con);

            // Commit transaction
            con.commit();

            System.out.println("Order placed successfully!");
            System.out.println("Order ID: " + orderId);
            System.out.println("Total Amount: " + total);

        } catch (Exception e) {
            try {
                if (con != null) con.rollback();
            } catch (SQLException ignored) {}
            System.out.println("Checkout failed.");
            e.printStackTrace();
        } finally {
            try {
                if (con != null) con.close();
            } catch (SQLException ignored) {}
        }
    }
    
}


    


