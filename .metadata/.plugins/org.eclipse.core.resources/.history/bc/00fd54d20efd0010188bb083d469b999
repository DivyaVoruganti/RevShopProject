package com.revshop.dao;

import java.sql.Connection;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import java.util.List;
import java.util.ArrayList;

import com.revshop.model.CartItem;

import com.revshop.util.DBConnection;

public class cartDAO {
	public void addToCart(int userId, int productId, int quantity) {

		Connection con = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		String checkSql = "SELECT quantity FROM cart WHERE user_id=? AND product_id=?";
		String insertSql = "INSERT INTO cart(cart_id,user_id, product_id, quantity)"+" VALUES(cart_seq.NEXTVAL,?,?,?)";
		String updateSql = "UPDATE cart SET quantity = quantity + ? WHERE user_id=? AND product_id=?";

		try {
			con = DBConnection.getConnection();

			ps = con.prepareStatement(checkSql);
			ps.setInt(1, userId);
			ps.setInt(2, productId);
//            ps.setInt(3, quantity);


			rs = ps.executeQuery();

			if (rs.next()) {
				ps = con.prepareStatement(updateSql);
				ps.setInt(1, quantity);
				ps.setInt(2, userId);
				ps.setInt(3, productId);
				ps.executeUpdate();
			} else {
				ps = con.prepareStatement(insertSql);
				ps.setInt(1, userId);
				ps.setInt(2, productId);
				ps.setInt(3, quantity);
				ps.executeUpdate();
			}

			System.out.println(" Product added to cart");

		} catch (Exception e) {
			e.printStackTrace();
		}finally {
            try {
                if (rs != null) rs.close();
                if (ps != null) ps.close();
                if (con != null) con.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
		
	}
	public void viewCart(int userId) {
	    Connection con = null;
	    PreparedStatement ps = null;
	    ResultSet rs = null;

	    String sql = "SELECT c.cart_id, p.name, p.PRICE, c.quantity, " +
	                 "       (p.PRICE * c.quantity) AS TOTAL " +
	                 "FROM cart c " +
	                 "JOIN products p ON c.product_id = p.product_id " +
	                 "WHERE c.user_id = ?";

	    try {
	        con = DBConnection.getConnection();
	        ps = con.prepareStatement(sql);
	        ps.setInt(1, userId);
	        rs = ps.executeQuery();

	        System.out.println("ID | Name | Price | Qty | Total");
	        boolean empty = true;

	        while (rs.next()) {
	            empty = false;
	            System.out.println(
	                rs.getInt("CART_ID") + " | " +
	                rs.getString("NAME") + " | " +
	                rs.getDouble("PRICE") + " | " +
	                rs.getInt("QUANTITY") + " | " +
	                rs.getDouble("TOTAL")
	            );
	        }

	        if (empty) {
	            System.out.println("Cart is empty");
	        }

	    } catch (SQLException e) {
	        e.printStackTrace();
	    } finally {
	        try {
	            if (rs != null) rs.close();
	            if (ps != null) ps.close();
	            if (con != null) con.close();
	        } catch (SQLException e) {
	            e.printStackTrace();
	        }
	    }
	}

	
	
	public List<CartItem> getCartItems(int userId, Connection con) throws SQLException {

	    List<CartItem> items = new ArrayList<CartItem>();

	    String sql = "SELECT product_id, quantity, price FROM cart WHERE user_id=?";
	    PreparedStatement ps = con.prepareStatement(sql);
	    ps.setInt(1, userId);

	    ResultSet rs = ps.executeQuery();

	    while (rs.next()) {
	        CartItem item = new CartItem(
	                rs.getInt("product_id"),
	                rs.getInt("quantity"),
	                rs.getDouble("price")
	        );
	        items.add(item);
	    }

	    rs.close();
	    ps.close();

	    return items;
	}

	 
	public void removeFromCart(int userId, int productId) {
		 Connection con = null;
	        PreparedStatement ps = null;

	        String sql = "DELETE FROM cart WHERE user_id=? AND product_id=?";

	        try {con = DBConnection.getConnection();
	            ps = con.prepareStatement(sql);

	            ps.setInt(1, userId);
	            ps.setInt(2, productId);

	            int rows = ps.executeUpdate();

	            if (rows > 0)
	                System.out.println(" Product removed from cart");
	            else
	                System.out.println("Product not found in cart");

	        } catch (Exception e) {
	            e.printStackTrace();
	        }
	    }
	public void clearCart(int userId,Connection con) throws SQLException {
//        Connection con = DBConnection.getConnection();
        String sql = "DELETE FROM cart WHERE user_id = ?";
        PreparedStatement ps = con.prepareStatement(sql);
        ps.setInt(1, userId);
        ps.executeUpdate();
        ps.close();
       
    }

}
