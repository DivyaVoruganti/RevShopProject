package com.revshop.service;

import java.util.Scanner;
import java.sql.SQLException;

import org.apache.log4j.Logger;

import com.revshop.dao.ProductDAO;
import com.revshop.dao.UserDAO;
import com.revshop.model.Product;

public class SellerService {

    private static final Logger logger = Logger.getLogger(SellerService.class);

    private ProductDAO productDAO = new ProductDAO();
    private UserDAO userDAO = new UserDAO();

    public void addProduct(String name, double mrp, double discountPrice,
                           int stock, String category, String description, int sellerId) {

        if (!isSeller(sellerId)) {
            logger.warn("Unauthorized add product attempt by userId: " + sellerId);
            return;
        }

        if (discountPrice > mrp) {
            logger.warn("Discount price greater than MRP for sellerId: " + sellerId);
            return;
        }

        Product product = new Product();
        product.setName(name);
        product.setMrp(mrp);
        product.setDiscountPrice(discountPrice);
        product.setStock(stock);
        product.setCategory(category);
        product.setDescription(description);
        product.setSellerId(sellerId);

        try {
            productDAO.addProduct(product);
            logger.info("Product added successfully by sellerId: " + sellerId);
        } catch (SQLException e) {
            logger.error("Error adding product for sellerId: " + sellerId, e);
        }
    }

    private boolean isSeller(int userId) {
        String role = userDAO.getRoleByUserId(userId);
        return "seller".equalsIgnoreCase(role);
    }

    public void viewSellerProducts(int sellerId) {
        try {
            productDAO.getProductsBySeller(sellerId);
            logger.info("Viewed products for sellerId: " + sellerId);
        } catch (Exception e) {
            logger.error("Error fetching products for sellerId: " + sellerId, e);
        }
    }

    public void updateProduct(int productId, int sellerId, String name, double mrp,
                              double discountPrice, int stock, String category, String description) {

        if (discountPrice > mrp) {
            logger.warn("Invalid price update (discount > mrp) for productId: " + productId);
            return;
        }

        Product product = new Product();
        product.setProductId(productId);
        product.setSellerId(sellerId);
        product.setName(name);
        product.setMrp(mrp);
        product.setDiscountPrice(discountPrice);
        product.setStock(stock);
        product.setCategory(category);
        product.setDescription(description);

        try {
            productDAO.updateProduct(product);
            logger.info("Product updated successfully. ProductId: " + productId);
        } catch (Exception e) {
            logger.error("Error updating productId: " + productId, e);
        }
    }

    public void updatePrice(int sellerId) {

        Scanner sc = new Scanner(System.in);

        try {
            logger.info("Updating price for sellerId: " + sellerId);

            int productId = Integer.parseInt(sc.nextLine());
            double newMrp = Double.parseDouble(sc.nextLine());
            double newDiscount = Double.parseDouble(sc.nextLine());

            if (newDiscount > newMrp) {
                logger.warn("Invalid price values for productId: " + productId);
                return;
            }

            Product product = new Product();
            product.setProductId(productId);
            product.setSellerId(sellerId);
            product.setMrp(newMrp);
            product.setDiscountPrice(newDiscount);

            productDAO.updateProductPrice(product);
            logger.info("Price updated for productId: " + productId);

        } catch (NumberFormatException e) {
            logger.error("Invalid numeric input while updating price", e);
        } catch (Exception e) {
            logger.error("Error updating product price for sellerId: " + sellerId, e);
        }
    }

    public void viewProductReviews(int sellerId) {
        try {
            productDAO.viewProductReviewsBySeller(sellerId);
            logger.info("Viewed product reviews for sellerId: " + sellerId);
        } catch (Exception e) {
            logger.error("Error fetching reviews for sellerId: " + sellerId, e);
        }
    }

    public void setInventoryThreshold(int sellerId) {

        Scanner sc = new Scanner(System.in);

        try {
            int productId = Integer.parseInt(sc.nextLine());
            int threshold = Integer.parseInt(sc.nextLine());

            productDAO.updateStockThreshold(productId, sellerId, threshold);
            logger.info("Inventory threshold updated. ProductId: " + productId);

        } catch (NumberFormatException e) {
            logger.error("Invalid numeric input while setting threshold", e);
        } catch (Exception e) {
            logger.error("Error updating inventory threshold for sellerId: " + sellerId, e);
        }
    }

    public void checkLowStockAlerts(int sellerId) {
        try {
            productDAO.checkLowStock(sellerId);
            logger.info("Checked low stock alerts for sellerId: " + sellerId);
        } catch (Exception e) {
            logger.error("Error checking low stock for sellerId: " + sellerId, e);
        }
    }

    public void deleteProduct(int productId, int sellerId) {
        try {
            productDAO.deleteProduct(productId, sellerId);
            logger.info("Product deleted successfully. ProductId: " + productId);
        } catch (Exception e) {
            logger.error("Error deleting productId: " + productId, e);
        }
    }

    public void sellerMenu(int sellerId, Scanner sc) {

        while (true) {

            try {
                int choice = Integer.parseInt(sc.nextLine());

                switch (choice) {
                    case 1:
                        viewSellerProducts(sellerId);
                        break;
                    case 2:
                        addProduct(
                                sc.nextLine(),
                                Double.parseDouble(sc.nextLine()),
                                Double.parseDouble(sc.nextLine()),
                                Integer.parseInt(sc.nextLine()),
                                sc.nextLine(),
                                sc.nextLine(),
                                sellerId
                        );
                        break;
                    case 3:
                        updateProduct(
                                Integer.parseInt(sc.nextLine()),
                                sellerId,
                                sc.nextLine(),
                                Double.parseDouble(sc.nextLine()),
                                Double.parseDouble(sc.nextLine()),
                                Integer.parseInt(sc.nextLine()),
                                sc.nextLine(),
                                sc.nextLine()
                        );
                        break;
                    case 4:
                        updatePrice(sellerId);
                        break;
                    case 5:
                        deleteProduct(Integer.parseInt(sc.nextLine()), sellerId);
                        break;
                    case 6:
                        viewProductReviews(sellerId);
                        break;
                    case 7:
                        setInventoryThreshold(sellerId);
                        break;
                    case 8:
                        checkLowStockAlerts(sellerId);
                        break;
                    case 9:
                        logger.info("Seller logged out. SellerId: " + sellerId);
                        return;
                    default:
                        logger.warn("Invalid seller menu choice");
                }

            } catch (NumberFormatException e) {
                logger.error("Invalid menu input", e);
            }
        }
    }
}
