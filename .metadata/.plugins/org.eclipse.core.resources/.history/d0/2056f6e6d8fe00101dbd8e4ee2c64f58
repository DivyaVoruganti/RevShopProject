package com.revshop.service;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import java.util.Scanner;

import org.apache.log4j.Logger;

import com.revshop.dao.cartDAO;
import com.revshop.model.CartItem;
import com.revshop.util.DBConnection;

public class CheckoutService {

    private static final Logger logger = Logger.getLogger(CheckoutService.class);

    private cartDAO cartDao1 = new cartDAO();
    private CartService cartService = new CartService();
    private NotificationService notificationService = new NotificationService();
    private Scanner sc = new Scanner(System.in);

    // ================= CLEAR CART =================
    public void clearCart(int userId) throws SQLException {

        Connection con = null;
        PreparedStatement ps = null;

        try {
            con = DBConnection.getConnection();
            String sql = "DELETE FROM cart WHERE user_id = ?";
            ps = con.prepareStatement(sql);
            ps.setInt(1, userId);
            ps.executeUpdate();

            logger.info("Cart cleared for userId: " + userId);

        } finally {
            try {
                if (ps != null) ps.close();
                if (con != null) con.close();
            } catch (SQLException e) {
                logger.error("Error closing resources in clearCart", e);
            }
        }
    }

    // ================= CHECKOUT =================
    public void checkout(int userId) {

        Connection con = null;

        try {
            con = DBConnection.getConnection();
            con.setAutoCommit(false);

            logger.info("Checkout started for userId: " + userId);

            // View cart
            cartDao1.viewCart(userId);

            sc.nextLine(); // consume newline
            logger.info("Waiting for shipping address input");
            String shipping = sc.nextLine();

            logger.info("Waiting for billing address input");
            String billing = sc.nextLine();

            List<CartItem> cartItems = cartDao1.getCartItems(userId, con);

            if (cartItems.isEmpty()) {
                logger.warn("Cart is empty. Checkout aborted for userId: " + userId);
                return;
            }

            double total = 0;
            for (CartItem item : cartItems) {
                total += item.getQuantity() * item.getPrice();
            }

            String orderSql =
                    "INSERT INTO orders (user_id, total_amount, shipping_address, billing_address) VALUES (?, ?, ?, ?)";
            PreparedStatement orderPs =
                    con.prepareStatement(orderSql, new String[] { "order_id" });

            orderPs.setInt(1, userId);
            orderPs.setDouble(2, total);
            orderPs.setString(3, shipping);
            orderPs.setString(4, billing);
            orderPs.executeUpdate();

            ResultSet orderKeys = orderPs.getGeneratedKeys();
            orderKeys.next();
            int orderId = orderKeys.getInt(1);

            String itemSql =
                    "INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)";
            PreparedStatement itemPs = con.prepareStatement(itemSql);

            for (CartItem item : cartItems) {
                itemPs.setInt(1, orderId);
                itemPs.setInt(2, item.getProductId());
                itemPs.setInt(3, item.getQuantity());
                itemPs.setDouble(4, item.getPrice());
                itemPs.addBatch();
            }

            itemPs.executeBatch();
            cartDao1.clearCart(userId, con);

            con.commit();

            logger.info("Order placed successfully. OrderId: " + orderId +
                        ", UserId: " + userId +
                        ", Total: " + total);

        } catch (Exception e) {
            try {
                if (con != null) con.rollback();
            } catch (SQLException ex) {
                logger.error("Rollback failed during checkout", ex);
            }
            logger.error("Checkout failed for userId: " + userId, e);

        } finally {
            try {
                if (con != null) con.close();
            } catch (SQLException e) {
                logger.error("Error closing DB connection after checkout", e);
            }
        }
    }
}
