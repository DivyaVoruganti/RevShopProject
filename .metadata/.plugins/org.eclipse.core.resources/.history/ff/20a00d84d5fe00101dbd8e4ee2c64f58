package com.revshop.service;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import org.apache.log4j.Logger;

import com.revshop.dao.UserDAO;
import com.revshop.util.DBConnection;

public class UserService {

    private static final Logger logger = Logger.getLogger(UserService.class);

    private UserDAO userDAO = new UserDAO();

    public boolean register(String name, String email, String password, String role) {
        logger.info("Registering user with email: " + email);
        return userDAO.register(name, email, password, role);
    }

    public boolean changePassword(String email, String newPwd) {
        logger.info("Changing password for email: " + email);
        return userDAO.changePassword(email, newPwd);
    }

    public String login(String email, String password) {
        logger.info("Login attempt for email: " + email);
        return userDAO.loginAndGetRole(email, password);
    }

    public int loginAndGetUserId(String email, String password) {

        int userId = -1;
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        try {
            con = DBConnection.getConnection();
            ps = con.prepareStatement(
                    "SELECT user_id FROM users WHERE email=? AND password=?"
            );
            ps.setString(1, email);
            ps.setString(2, password);

            rs = ps.executeQuery();
            if (rs.next()) {
                userId = rs.getInt("user_id");
            }

            logger.info("UserId fetched for email: " + email + ", UserId: " + userId);

        } catch (SQLException e) {
            logger.error("Error fetching userId for email: " + email, e);
        } finally {
            try { if (rs != null) rs.close(); } catch (SQLException e) {
                logger.error("Error closing ResultSet", e);
            }
            try { if (ps != null) ps.close(); } catch (SQLException e) {
                logger.error("Error closing PreparedStatement", e);
            }
            try { if (con != null) con.close(); } catch (SQLException e) {
                logger.error("Error closing DB Connection", e);
            }
        }

        return userId;
    }

    public String loginAndGetRole(String email, String password) {

        String role = null;
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        try {
            con = DBConnection.getConnection();
            ps = con.prepareStatement(
                    "SELECT role FROM users WHERE email=? AND password=?"
            );
            ps.setString(1, email);
            ps.setString(2, password);

            rs = ps.executeQuery();
            if (rs.next()) {
                role = rs.getString("role");
            }

            logger.info("Role fetched for email: " + email + ", Role: " + role);

        } catch (SQLException e) {
            logger.error("Error fetching role for email: " + email, e);
        } finally {
            try { if (rs != null) rs.close(); } catch (SQLException e) {
                logger.error("Error closing ResultSet", e);
            }
            try { if (ps != null) ps.close(); } catch (SQLException e) {
                logger.error("Error closing PreparedStatement", e);
            }
            try { if (con != null) con.close(); } catch (SQLException e) {
                logger.error("Error closing DB Connection", e);
            }
        }

        return role;
    }

    public String getRoleByUserId(int userId) {

        String role = null;
        Connection con = null;
        PreparedStatement ps = null;
        ResultSet rs = null;

        try {
            con = DBConnection.getConnection();
            ps = con.prepareStatement(
                    "SELECT role FROM users WHERE user_id=?"
            );
            ps.setInt(1, userId);

            rs = ps.executeQuery();
            if (rs.next()) {
                role = rs.getString("role");
            }

            logger.info("Role fetched for userId: " + userId + ", Role: " + role);

        } catch (SQLException e) {
            logger.error("Error fetching role for userId: " + userId, e);
        } finally {
            try { if (rs != null) rs.close(); } catch (SQLException e) {
                logger.error("Error closing ResultSet", e);
            }
            try { if (ps != null) ps.close(); } catch (SQLException e) {
                logger.error("Error closing PreparedStatement", e);
            }
            try { if (con != null) con.close(); } catch (SQLException e) {
                logger.error("Error closing DB Connection", e);
            }
        }

        return role;
    }
}
